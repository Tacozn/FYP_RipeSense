{% extends "base.html" %}
{% block title %}Live Analysis - RipeSense{% endblock %}

{% block content %}
<div class="container fade-in-up">
    <div class="text-center mb-4">
        <h2 class="fw-bold text-success">Real-Time Detection</h2>
        <p class="text-muted">Point your camera at a fruit to identify it instantly.</p>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            <div class="position-relative rounded-4 overflow-hidden shadow-lg mb-4 bg-black" style="min-height: 480px;">
                
                <div class="position-absolute top-0 start-0 w-100 p-3 d-flex justify-content-between z-2" 
                     style="background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent);">
                    
                    <div class="d-flex gap-2">
                        <span class="badge bg-black bg-opacity-50 border border-success text-success fw-normal backdrop-blur">
                            <i class="fas fa-eye me-1"></i> YOLOv8-Nano
                        </span>
                        <span id="latencyTag" class="badge bg-black bg-opacity-50 border border-white text-white fw-normal font-monospace backdrop-blur">
                            -- ms
                        </span>
                    </div>

                    <div>
                        <span id="liveBadge" class="badge bg-danger rounded-pill px-3 shadow-sm d-none pulse-live">
                            <i class="fas fa-circle me-1 small"></i> LIVE
                        </span>
                    </div>
                </div>

                <div class="scan-grid w-100 h-100 position-absolute top-0 start-0 opacity-25" style="pointer-events: none;"></div>

                <div class="position-absolute top-50 start-50 translate-middle d-none d-md-block opacity-50" style="pointer-events: none;">
                    <div style="width: 250px; height: 250px; border: 2px dashed rgba(255,255,255,0.4); border-radius: 20px;"></div>
                    <div style="width: 270px; height: 2px; background: rgba(255,255,255,0.2); position: absolute; top: 50%; left: -10px;"></div>
                    <div style="height: 270px; width: 2px; background: rgba(255,255,255,0.2); position: absolute; top: -10px; left: 50%;"></div>
                </div>

                <video id="video" autoplay playsinline class="w-100 h-100" style="object-fit: cover; display: none;"></video>
                <canvas id="canvas" class="w-100 h-100 position-absolute top-0 start-0" style="pointer-events: none;"></canvas>

                <div id="cameraPlaceholder" class="position-absolute top-50 start-50 translate-middle text-center text-white">
                    <div class="mb-3">
                        <i class="fas fa-video-slash fa-4x opacity-25"></i>
                    </div>
                    <h5 class="fw-bold opacity-75">Camera is Offline</h5>
                    <p class="small opacity-50">Click "Start Stream" to begin analysis.</p>
                </div>
            </div>

            <div class="card border-0 shadow-sm rounded-pill mb-4 px-4 py-3 bg-white">
                <div class="row align-items-center">
                    
                    <div class="col-4 d-none d-md-block">
                        <div class="d-flex align-items-center">
                            <div id="statusDot" class="rounded-circle bg-secondary me-2" style="width: 10px; height: 10px;"></div>
                            <span id="statusText" class="fw-bold text-muted small text-uppercase">Standby</span>
                        </div>
                    </div>

                    <div class="col-12 col-md-4 text-center">
                        <button id="toggleBtn" onclick="toggleStream()" class="btn btn-success rounded-pill px-5 py-2 shadow fw-bold w-100 w-md-auto">
                            <i class="fas fa-power-off me-2"></i> Start Stream
                        </button>
                    </div>

                    <div class="col-4 d-none d-md-block text-end">
                         <button class="btn btn-light rounded-circle border text-muted hover-effect" 
                                 type="button" 
                                 data-bs-toggle="collapse" 
                                 data-bs-target="#testTools" 
                                 title="Developer Tools"
                                 style="width: 40px; height: 40px;">
                            <i class="fas fa-flask"></i>
                         </button>
                    </div>
                </div>
            </div>

            <div class="collapse" id="testTools">
                <div class="card border-0 shadow-sm rounded-4 bg-light mb-5 border border-success border-opacity-10">
                    <div class="card-body">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <h6 class="fw-bold text-success mb-0"><i class="fas fa-vial me-2"></i>Developer Simulation Mode</h6>
                            <button type="button" class="btn-close" data-bs-toggle="collapse" data-bs-target="#testTools"></button>
                        </div>
                        <p class="small text-muted mb-3">Upload an image to test the detection logic without using the webcam.</p>
                        
                        <div class="row g-2 align-items-center">
                            
                            <div class="col-12 col-md"> 
                                <input type="file" id="testImageInput" accept="image/*" class="form-control rounded-pill border-0 shadow-sm">
                            </div>
                            
                            <div class="col-12 col-md-auto">
                                <button id="testBtn" onclick="startTestMode()" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm w-100">
                                    Run Test
                                </button>
                                <button id="stopTestBtn" onclick="stopTestMode()" class="btn btn-outline-danger rounded-pill px-4 shadow-sm w-100" style="display: none;">
                                    Stop
                                </button>
                            </div>
                            
                        </div>

                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    /* Small CSS tweak for the blurred background effect on badges */
    .backdrop-blur {
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
    }
</style>

<script>
    // --- VARIABLES ---
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    // UI Elements
    const latencyTag = document.getElementById('latencyTag');
    const toggleBtn = document.getElementById('toggleBtn');
    const cameraPlaceholder = document.getElementById('cameraPlaceholder');
    const liveBadge = document.getElementById('liveBadge');
    const statusText = document.getElementById('statusText');
    const statusDot = document.getElementById('statusDot');

    // Ghost Canvas (Invisible) - Captures image for AI
    const ghostCanvas = document.createElement('canvas');
    const ghostCtx = ghostCanvas.getContext('2d');

    let isRunning = false;
    let isProcessing = false;
    let isTestMode = false;
    let testImage = null; 

    // Ensure canvas stays on top
    canvas.style.zIndex = "10"; 

    // --- MAIN CONTROLS ---

    async function toggleStream() {
        if (isRunning) {
            stopStream();
        } else {
            startStream();
        }
    }

    function startStream() {
        console.log("üöÄ Attempting to start camera...");

        navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment', // Tries back camera on mobile
                width: { ideal: 640 }, 
                height: { ideal: 480 } 
            } 
        })
        .then(stream => {
            console.log("‚úÖ Camera access granted!");
            video.srcObject = stream;
            
            // Wait for video to be ready before starting loop
            video.onloadedmetadata = () => {
                console.log("üìè Metadata loaded. Dimensions:", video.videoWidth, video.videoHeight);
                
                // Setup dimensions to match camera
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ghostCanvas.width = video.videoWidth;
                ghostCanvas.height = video.videoHeight;
                
                isRunning = true;
                
                // üü¢ UI UPDATE: CAMERA ON
                video.style.display = 'block';
                cameraPlaceholder.style.display = 'none';
                
                toggleBtn.innerHTML = '<i class="fas fa-stop me-2"></i> Stop Stream';
                toggleBtn.classList.replace('btn-success', 'btn-outline-danger');
                
                liveBadge.classList.remove('d-none');
                
                statusText.innerText = "Active Scan";
                statusText.classList.replace('text-muted', 'text-success');
                statusDot.classList.replace('bg-secondary', 'bg-success');
                statusDot.classList.add('pulse-live'); 
                
                // üöÄ START THE LOOP
                requestAnimationFrame(processFrame);
            };
        })
        .catch(err => {
            console.error("‚õî Camera Error:", err);
            alert("Could not start camera. \n\nCheck:\n1. Is your browser allowing camera access?\n2. Are you on HTTPS or localhost?");
        });
    }

    function stopStream() {
        console.log("üõë Stopping stream...");
        isRunning = false; // Stops the loop

        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
        }
        video.srcObject = null;

        // üî¥ UI UPDATE: CAMERA OFF
        video.style.display = 'none';
        cameraPlaceholder.style.display = 'block';
        
        toggleBtn.innerHTML = '<i class="fas fa-power-off me-2"></i> Start Stream';
        toggleBtn.classList.replace('btn-outline-danger', 'btn-success');
        
        liveBadge.classList.add('d-none');
        
        statusText.innerText = "Standby";
        statusText.classList.replace('text-success', 'text-muted');
        statusDot.classList.replace('bg-success', 'bg-secondary');
        statusDot.classList.remove('pulse-live');

        // Clear the canvas results
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        latencyTag.innerText = "-- ms";
    }

    async function processFrame() {
        // STOP check
        if (!isRunning && !isTestMode) return;
        
        // BUSY check (Prevent overlapping requests)
        if (isProcessing) {
            requestAnimationFrame(processFrame);
            return;
        }

        isProcessing = true;
        const startTime = Date.now();

        try {
            // 1. Capture Frame (Test Mode or Camera)
            if (isTestMode && testImage) {
                ghostCtx.drawImage(testImage, 0, 0, ghostCanvas.width, ghostCanvas.height);
            } else {
                // Only draw if video has valid dimensions
                if (video.videoWidth > 0 && video.videoHeight > 0) {
                    ghostCtx.drawImage(video, 0, 0, ghostCanvas.width, ghostCanvas.height);
                }
            }
            
            // 2. Send to AI
            const imageData = ghostCanvas.toDataURL('image/jpeg', 0.5); 
            
            const response = await fetch('/detect_objects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image_data: imageData })
            });

            const data = await response.json();

            // üõë ADD THIS SAFETY CHECK HERE üõë
            // If the user clicked stop while we were waiting for the AI, 
            // do NOT draw the result.
            if (!isRunning && !isTestMode) {
                ctx.clearRect(0, 0, canvas.width, canvas.height); // Ensure clean
                isProcessing = false;
                return;
            }
            // üõë END ADDITION üõë

            // 3. Draw Results
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Scaling logic for Test Mode
            function getScaledCoords(bbox) {
                let [x1, y1, x2, y2] = bbox;
                if (isTestMode && testImage && testImage.scaleX) {
                    x1 = x1 * testImage.scaleX + testImage.offsetX;
                    y1 = y1 * testImage.scaleY + testImage.offsetY;
                    x2 = x2 * testImage.scaleX + testImage.offsetX;
                    y2 = y2 * testImage.scaleY + testImage.offsetY;
                }
                return [x1, y1, x2, y2];
            }

            // Draw each detected box
            if (data && data.length > 0) {
                data.forEach(obj => {
                    let [x1, y1, x2, y2] = getScaledCoords(obj.bbox);
                    const width = x2 - x1;
                    const height = y2 - y1;
                    
                    // Box Style
                    ctx.shadowColor = '#00E676';
                    ctx.shadowBlur = 10;
                    ctx.strokeStyle = '#00E676';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(x1, y1, width, height);
                    ctx.shadowBlur = 0;

                    // Label Style
                    const label = `${obj.class} ${Math.round(obj.confidence * 100)}%`;
                    ctx.font = 'bold 16px "Courier New", monospace';
                    const textWidth = ctx.measureText(label).width;
                    
                    ctx.fillStyle = 'rgba(0, 230, 118, 0.8)';
                    ctx.fillRect(x1, y1 - 25, textWidth + 10, 25);
                    
                    ctx.fillStyle = '#000';
                    ctx.fillText(label, x1 + 5, y1 - 7);
                });
            }

            // Update Latency
            const duration = Date.now() - startTime;
            latencyTag.innerText = `${duration} ms`;

        } catch (err) {
            console.error("Frame Processing Error:", err);
        } finally {
            isProcessing = false;
            // Loop again if still running
            if (isRunning) requestAnimationFrame(processFrame);
        }
    }

    // --- TEST MODE FUNCTIONS ---
    function startTestMode() {
        const fileInput = document.getElementById('testImageInput');
        if (!fileInput.files || !fileInput.files[0]) {
            alert('Please select an image first!');
            return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            testImage = new Image();
            testImage.onload = function() {
                if (isRunning) stopStream();
                
                const container = document.querySelector('.bg-black');
                const containerW = container.clientWidth;
                const containerH = container.clientHeight;
                
                canvas.width = containerW;
                canvas.height = containerH;
                ghostCanvas.width = testImage.width;
                ghostCanvas.height = testImage.height;
                
                // Scale Logic
                const scale = Math.min(containerW / testImage.width, containerH / testImage.height);
                const displayW = testImage.width * scale;
                const displayH = testImage.height * scale;
                const offX = (containerW - displayW) / 2;
                const offY = (containerH - displayH) / 2;

                let displayImg = document.getElementById('testDisplayImg');
                if(!displayImg) {
                    displayImg = document.createElement('img');
                    displayImg.id = 'testDisplayImg';
                    displayImg.style.position = 'absolute';
                    displayImg.style.zIndex = '1';
                    container.appendChild(displayImg);
                }
                displayImg.src = e.target.result;
                displayImg.style.width = displayW + 'px';
                displayImg.style.height = displayH + 'px';
                displayImg.style.left = offX + 'px';
                displayImg.style.top = offY + 'px';
                displayImg.style.display = 'block';
                
                cameraPlaceholder.style.display = 'none';
                
                isTestMode = true;
                testImage.scaleX = scale;
                testImage.scaleY = scale;
                testImage.offsetX = offX;
                testImage.offsetY = offY;

                document.getElementById('testBtn').style.display = 'none';
                document.getElementById('stopTestBtn').style.display = 'inline-block';
                toggleBtn.disabled = true;
                
                statusText.innerText = "Simulation Mode";
                statusText.classList.replace('text-muted', 'text-warning');
                statusDot.classList.replace('bg-secondary', 'bg-warning');

                setTimeout(() => requestAnimationFrame(processFrame), 100);
            };
            testImage.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function stopTestMode() {
        isTestMode = false;
        const displayImg = document.getElementById('testDisplayImg');
        if(displayImg) displayImg.style.display = 'none';
        
        cameraPlaceholder.style.display = 'block';
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        document.getElementById('testBtn').style.display = 'inline-block';
        document.getElementById('stopTestBtn').style.display = 'none';
        toggleBtn.disabled = false;
        
        statusText.innerText = "Standby";
        statusText.classList.replace('text-warning', 'text-muted');
        statusDot.classList.replace('bg-warning', 'bg-secondary');
        latencyTag.innerText = "-- ms";
    }
</script>
{% endblock %}