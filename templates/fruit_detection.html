{% extends "base.html" %}
{% block title %}Live - RipeSense{% endblock %}

{% block content %}
<div class="container fade-in-up">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">Live Object Detection</h2>
                <span class="badge bg-danger rounded-pill px-3 py-2">
                    <span class="recording-indicator me-2"></span> LIVE FEED
                </span>
            </div>

            <div class="camera-container aspect-ratio-16x9 mb-4">
                
                <div class="hud-overlay">
                    <span class="badge bg-black bg-opacity-50 border border-success text-success font-monospace">
                        YOLOv8 MODEL ACTIVE
                    </span>
                </div>
                <div class="scan-grid"></div>

                <video id="video" autoplay playsinline class="w-100" style="display: block;"></video>
                <canvas id="canvas" class="w-100 h-100" style="position: absolute; top: 0; left: 0;"></canvas>
            
            </div>

            <div class="card glass-card border-0 p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="fw-bold">Session Controls</h5>
                        <p class="text-muted small mb-0">Stream runs locally in browser. No data is sent to server.</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <a href="/" class="btn btn-outline-danger rounded-pill px-4">Stop Stream</a>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // Access Webcam
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => {
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                startDetection(); // Start the loop
            };
        })
        .catch(err => console.error("Camera Error:", err));

    function startDetection() {
        setInterval(() => {
            // Draw video to canvas (hidden processing step)
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg');

            // Send to Backend
            fetch('/detect_objects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image_data: imageData })
            })
            .then(response => response.json())
            .then(data => {
                ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear old boxes
                
                data.forEach(obj => {
                    const [x1, y1, x2, y2] = obj.bbox;
                    const width = x2 - x1;
                    const height = y2 - y1;

                    // Draw Bounding Box
                    ctx.strokeStyle = '#00E676'; // Bright Green (Material Design)
                    ctx.lineWidth = 4;
                    ctx.strokeRect(x1, y1, width, height);

                    // Draw Label Background
                    ctx.fillStyle = '#00E676';
                    const text = `${obj.class} ${Math.round(obj.confidence * 100)}%`;
                    const textWidth = ctx.measureText(text).width;
                    
                    // Draw label background box
                    ctx.fillRect(x1, y1 - 25, textWidth + 10, 25);
                    
                    // Draw Text
                    ctx.fillStyle = '#000000'; // Black text for contrast
                    ctx.font = 'bold 16px Arial';
                    ctx.fillText(text, x1 + 5, y1 - 7);
                });
            })
            .catch(err => console.log("Detection Error (Is backend running?):", err));
        }, 500); // Run every 500ms (2 FPS)
    }
</script>
{% endblock %}